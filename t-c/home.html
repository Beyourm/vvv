<!doctype html>

<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ÙˆÙ‘ÙÙ‚</title>
    <meta property="og:title" content="Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ÙˆÙ‘ÙÙ‚" />
    <meta property="og:description" content="Ø±Ø§Ø¬Ø¹ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø­Ø§Ù„ØªÙƒ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ." />
    <meta property="og:image" content="https://skillia.netlify.app/images/photo.jpg" />
    <meta property="og:url" content="https://sklilia.netlify.app/Trainees_Records" />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="ar_AR" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../assets/fonts/tajawal.css">
    <link rel="stylesheet" href="../assets/fonts/cairo.css"> <link rel="stylesheet" href="table-styles.css">
    <link rel="stylesheet" href="style.css">


<style>
/* ===============================
   Ø³ØªØ§ÙŠÙ„Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø§Øª (Dialog Content Styles)
   ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ù…Ù† Ù…Ù„Ù dialog.html
   =============================== */
  #courses-dialog .dialog-content-wrapper {
      width: 100%;
      max-width: 450px;
      margin: 0 auto;
      background: #fff;
      padding: 10px;
  }

  /* ØªÙ… Ø¥Ø²Ø§Ù„Ø© .dialog-overlay Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
  
  .dialog-box {
    /* ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù„ÙŠÙƒÙˆÙ† Ø¨Ù…Ø«Ø§Ø¨Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù€ dialog */
    background: #fff;
    border-radius: 10px; 
    padding: 15px;
    box-shadow: none;
    text-align: right;
  }

  .dialog-header-courses {
    font-size: 18px; 
    font-weight: 700;
    color: #222;
    text-align: center;
    margin-bottom: 10px; 
  }

  .toggle-btn-courses {
    background: #2563eb;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 10px;
    cursor: pointer;
    margin-top: 15px;
    font-size: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    width: 100%;
    transition: all 0.3s ease;
  }

  .toggle-btn-courses:hover {
    background: #1d4ed8;
    transform: scale(1.03);
  }

  .arrow-courses {
    transition: transform 0.3s ease;
  }

  .arrow-courses.rotate {
    transform: rotate(180deg);
  }

  .course-list {
    margin-top: 15px;
    display: none; 
    border-top: 1px solid #ddd;
    padding-top: 10px;
    max-height: 400px; /* Ù„ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø§ÙŠÙ„ÙˆØ¬ */
    overflow-y: auto;   
    padding-right: 5px; 
  }

  .course-item {
    background: #f9fafb;
    padding: 10px 15px;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex; 
    justify-content: space-between; 
    align-items: center;
  }

  .course-item:hover {
    background: #e0e7ff;
    color: #1e40af;
  }

  .message-courses {
    text-align: center;
    margin-top: 12px;
    color: #16a34a;
    font-weight: 600;
    display: none;
    padding: 10px;
    border: 1px solid #c8e6c9;
    background: #f1fff1;
    border-radius: 8px;
  }

  .levies-text-red {
    color: #ef4444; 
    font-weight: 700;
    font-size: 15px;
    background: #fee2e2; 
    padding: 3px 8px;
    border-radius: 6px;
  }

  /* Ø³ØªØ§ÙŠÙ„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø§ÙŠÙ„ÙˆØ¬ */
  #courses-dialog .close-btn { 
    padding: 10px 20px; 
    background-color: #007b83; 
    color: white; 
    border: none; 
    border-radius: 5px; 
    cursor: pointer;
    margin-top: 20px;
    width: 100%;
  }

  /* Ø³ØªØ§ÙŠÙ„Ø§Øª Ø§Ù„Ø¯Ø§ÙŠÙ„ÙˆØ¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
  dialog {
      border: none;
      border-radius: 12px;
      padding: 0;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      background-color: transparent;
  }
  dialog::backdrop {
      background: rgba(0, 0, 0, 0.6);
  }
</style>

</head>
<body>
    <div class="dashboard-container">
        <header>
            <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ÙˆÙ‘ÙÙ‚</h1>
            <p id="marketer-id-display">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
              <div class="menu-toggle" id="menu-toggle">
    <i class="fas fa-bars"></i>
  </div>


  <nav>
        <a href="../contact.html">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</a>
        <a href="w-c.html"> Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª</a>

        <button id="show-courses-btn">Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</button>
    </nav>


        </header>


<div id="discount-container" style="display:none; margin:12px 0; text-align:center;">
  <input id="discount-input" type="text" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ®ÙÙŠØ¶" style="padding:8px 10px; border-radius:6px; width:220px;" />
  <button id="discount-search-btn" title="Ø§Ù„ØªØ­Ù‚Ù‚" style="margin-left:8px; padding:8px 10px; border-radius:6px; cursor:pointer;">
    <i class="fas fa-search"></i>
  </button>
</div>


            <div id="statusMessage" class="loading" style="text-align:center; color:#555;">
                <span class="spinner"></span> Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
            </div>

            <div id="dashboardContent" style="display:none;">

                <div class="stats-grid">
                    <div class="stats-card">

                        <h2><i class="fas fa-users card-title-icon"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„ÙŠÙ† Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</h2>
                        <span class="stats-count" id="referrals-count">0</span>
                    </div>
                    <div class="stats-card active-card">
                        <h2><i class="fas fa-check-circle card-title-icon"></i> Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ† (Ø§Ù„Ø­Ø§Ù„Ø© Y)</h2>
                        <span class="stats-count" id="active-referrals-count">0</span>
                    </div>
                </div>

                <div class="card-wrapper" style="margin-bottom: 25px;">
                    <div class="card" id="balance-card">
                        <h2 class="card-title">Ø±ØµÙŠØ¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
                        <div class="balance" id="current-balance"><div class="loader"></div></div>

                        <div class="sub-stats">
                          <div class="total">ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total-members">...</span></div>
                          <div class="active">âœ… Ù†Ø´Ø·ÙˆÙ†: <span id="active-members">...</span></div>
                          <div class="inactive">âŒ Ø®Ø§Ù…Ù„ÙˆÙ†: <span id="inactive-members">...</span></div>
                        </div>

                        <div class="donut" id="statusDonut"></div>

                        <div class="current-rank">
                          ğŸ¯ Ù…Ø±ÙƒØ²Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="current-rank">...</span>
                        </div>

                        <div class="top3">
                          <h3>ğŸ† Ø£ÙØ¶Ù„ 3 Ù…Ø³ÙˆÙ‘Ù‚ÙŠÙ†</h3>
                          <ol id="top3-list">
                            <li>...</li>
                            <li>...</li>
                            <li>...</li>
                          </ol>
                        </div>

                        <button id="refresh-balance">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    </div>
                </div>
                <div class="stats-card" style="margin-bottom: 20px;">
                    <h2 style="margin-top: 0;"><i class="fas fa-link card-title-icon"></i> Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</h2>
                    <div class="referral-link-box" id="referral-link-box" title="Ø§Ø¶ØºØ· Ù„Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·">
                        <span id="referral-link-text">...</span>
                        <button class="copy-btn" id="copy-btn"><i class="fas fa-copy"></i> Ù†Ø³Ø®</button>
                    </div>
                    <p style="font-size: 12px; color: #555; margin-top: 10px;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ù„Ø²Ø± Ù„Ù†Ø³Ø®Ù‡ ÙˆÙ…Ø´Ø§Ø±ÙƒØªÙ‡.</p>
                </div>

                <h2 style="color: var(--primary-color); border-bottom: 2px solid var(--secondary-color); padding-bottom: 5px; margin-bottom: 20px;"><i class="fas fa-address-card card-title-icon"></i> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h2>
                <div class="details-card" id="personal-details">
                </div>

                <div class="referrals-section">
                    <div class="referrals-header">
                        <div class="top-row">
                            <h2 style="margin: 0; color: var(--primary-color); font-size: 18px; font-weight: 700;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„ÙŠÙ† Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø·</h2>
                            <button class="download-btn" id="download-btn" style="display:none;">
                                <i class="fas fa-download" style="margin-left: 5px; color: var(--primary-color);"></i>
                                ØªÙ†Ø²ÙŠÙ„ ÙƒÙ…Ù„Ù CSV
                            </button>
                        </div>
                        <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ..." oninput="filterReferrals()">
                    </div>

                    <div class="cards-container" id="referrals-table-container">
                    </div>
                </div>

                <p style="text-align:center; font-size:12px; color:#888; margin-top: 30px;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø«Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…ÙŠ Ù„Ù…Ø¤Ø³Ø³Ø© ÙƒÙ† Ø£Ù†Øª.</p>

            </div>
        </div>
    </div>
    <div id="toastNotification" class="toast-notification">
        <i class="fas fa-check-circle"></i> ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©!
    </div>
    <div id="toast" class="toast">ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…</div>


    <dialog id="courses-dialog">
        <div class="dialog-content-wrapper">

             <div class="dialog-box">
                <div class="dialog-header-courses" id="dialogHeaderCourses">ğŸ“Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ù„ØªØ³ÙˆÙ‚ Ù„Ù‡Ø§ </div>
                <button class="toggle-btn-courses" id="toggleButtonCourses">
                    Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙˆØ±Ø§Øª <span class="arrow-courses" id="arrowCourses">ğŸ”»</span>
                </button>

                <div class="course-list" id="courseList">
                    </div>

                <div class="message-courses" id="messageCourses">ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· âœ…</div>
            </div>

            <form method="dialog" style="text-align: center; margin-top: 10px;">
                <button class="close-btn">Ø¥ØºÙ„Ø§Ù‚</button>
            </form>
        </div>
    </dialog>


      <script>
        document.addEventListener('DOMContentLoaded', function() {
            const showCoursesBtn = document.getElementById('show-courses-btn');
            const coursesDialog = document.getElementById('courses-dialog');

            if (showCoursesBtn && coursesDialog) {
                showCoursesBtn.addEventListener('click', function() {
                    // ğŸ’¡ Ù‡Ù†Ø§ ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¯Ø§ÙŠÙ„ÙˆØ¬ Ù‚Ø¨Ù„ Ø¹Ø±Ø¶Ù‡
                    initializeDialog(); 
                    coursesDialog.showModal();
                });
            }
        });
    </script>


<footer id="mainFooter" class="footer" style="display: none;">
  <div class="footer-container">
    <p>Â© 2025 Ù…Ø¤Ø³Ø³Ø© ÙƒÙ† Ø£Ù†Øª Ù„Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„ØªØ£Ù‡ÙŠÙ„</p>
    <button id="logoutBtn" class="btn-logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</footer>

<style>

/* ===============================
   CSS Ù…Ø®ØµØµ Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ù…Ù†Ø§ÙØ³Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© (Balance.html)
   (Ù…Ø­ØªÙØ¸ Ø¨Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
   =============================== */
.footer {
    background-color: #0d3b14;
    color: #ffffff;
    padding: 15px 20px;
    text-align: center;
    width: 100%;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.2);
    font-family: 'Tajawal', sans-serif;
    box-sizing: border-box;
}

.footer-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
    flex-wrap: wrap;
}

.btn-logout {
    background-color: #28a745;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s, transform 0.2s;
    flex-shrink: 0;
}

.btn-logout:hover {
    background-color: #218838;
    transform: translateY(-2px);
}

body {
    padding-bottom: 70px;
}

@media (max-width: 768px) {
    .footer-container {
        flex-direction: column;
        align-items: center;
        gap: 10px;
        text-align: center;
    }
}


:root {
  --primary-color: #007b83; /* Ù„ÙˆÙ† Ø£Ø³Ø§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯ */
  --accent-color: #f0f4f8; /* Ù„ÙˆÙ† Ø«Ø§Ù†ÙˆÙŠ */
}

.card-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  margin: 10px 0;
}

.card {
  background: linear-gradient(145deg, #ffffff, var(--accent-color));
  border-radius: 25px;
  padding: 25px 30px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  text-align: center;
  width: 100%;
  max-width: 420px;
  transition: all 0.3s ease, box-shadow 0.3s ease;
  position: relative;
  overflow: hidden;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.card::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(0,123,131,0.08) 0%, transparent 60%);
  opacity: 0;
  transition: opacity 0.4s ease;
  pointer-events: none;
}
.card:hover::before { opacity: 1; }

.card-title {
  font-size: 1.6rem;
  color: var(--primary-color);
  margin-bottom: 20px;
  letter-spacing: 0.5px;
}

.balance {
  font-size: 2.8rem;
  font-weight: bold;
  color: #222;
  margin-bottom: 20px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid var(--primary-color);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  margin: 0 auto;
  animation: spin 1s linear infinite;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.sub-stats {
  display: flex;
  justify-content: space-around;
  margin-bottom: 20px;
  font-weight: bold;
}
.sub-stats div { padding: 8px 12px; border-radius: 12px; }
.sub-stats .total { background: #cce5ff; color: #004085; }
.sub-stats .active { background: #d4edda; color: #155724; }
.sub-stats .inactive { background: #f8d7da; color: #721c24; }

.donut {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: conic-gradient(#28a745 0% 50%, #dc3545 50% 100%);
  margin: 10px auto;
  transition: background 1s ease;
}

#refresh-balance {
  margin-top: 10px;
  padding: 10px 22px;
  border: none;
  border-radius: 10px;
  background: var(--primary-color);
  color: white;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.3s;
}
#refresh-balance:hover { background: #005f63; }

.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--primary-color);
  color: white;
  padding: 10px 18px;
  border-radius: 10px;
  opacity: 0;
  transition: opacity 0.5s;
  z-index: 1000;
}
.toast.show { opacity: 1; }

.current-rank {
  font-size: 1.2rem;
  margin: 15px 0;
  font-weight: bold;
  color: #ff6600;
}

.top3 {
  margin-bottom: 15px;
}
.top3 h3 { margin-bottom: 8px; font-size: 1.2rem; color: var(--primary-color); }
.top3 ol { padding-left: 20px; text-align: right; }
.top3 li { margin-bottom: 5px; font-weight: bold; }
.top3 li:nth-child(1) { color: #FFD700; }
.top3 li:nth-child(2) { color: #C0C0C0; }
animation: heartbeat 1.5s infinite;

.top3 li:nth-child(3) { color: #cd7f32; }

</style>

<script>

  const DEVICE_SERIAL_KEY = 'marketer_device_serial';
  const MARKETER_SESSION_KEY = 'marketer_session_data';
  const OTP_PENDING_KEY = 'otp_pending_login';
  // Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø®Ø²Ù‘Ù† Ø¨ÙˆØ§Ø³Ø·Ø© marketer_tracker.js
  const LOCAL_MARKETER_KEY = 'stored_marketer_id'; 


  // ------------------------------------------------------------------
  // ** Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ÙˆØªØ´ØºÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… **
  // ------------------------------------------------------------------
  function getMarketerId() {
      // ğŸš¨ Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„ÙˆØ­ÙŠØ¯ Ù‡Ùˆ localStorage
      return localStorage.getItem(LOCAL_MARKETER_KEY);
  }
  
  // ğŸ’¡ Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±Ù Ù…Ù† localStorage Ø£Ùˆ Ø±Ø§Ø¨Ø· URL Ø§Ù„Ø­Ø§Ù„ÙŠ
  function getMarketerIdForDialog() {
       const storedId = getMarketerId();
       if (storedId) return storedId;

       // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ù„Ø§Øµ Ù…Ù† Ø±Ø§Ø¨Ø· URL Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„ØµÙØ­Ø© ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯Ù‡ ÙÙŠ localStorage
       const urlParams = new URLSearchParams(window.location.search);
       return urlParams.get('marketer_id') || urlParams.get('id') || 'TTTTTT11';
  }


  function initDashboard() {
      const marketerId = getMarketerId();
      
      if (marketerId) {
          console.log("Marketer ID loaded from storage:", marketerId);
          fetchData(marketerId);
          initBalanceDisplay();
          renderDiscountSection(); 
      } else {
          // ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          updateStatus(`
              âš ï¸ **Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ù…ÙÙ‚ÙˆØ¯.** Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ marketer_id) Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
              <br>
              <span style="font-size: 0.9em;">
              Ø¥Ø°Ø§ ÙƒÙ†Øª ØªÙØªØ­ Ø§Ù„Ù„ÙˆØ­Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©ØŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©.
              </span>
              `, 'error');
          marketerIdDisplay.innerHTML = `Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ù…ÙÙ‚ÙˆØ¯ (Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©).`;
          dashboardContent.style.display = 'none';
          document.getElementById('current-balance').textContent = '...';
      }
  }

  // ------------------------------------------------------------------
  // ** Ù…Ù†Ø·Ù‚ Ø§Ù„ÙÙˆØªØ± ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ **
  // ------------------------------------------------------------------

  document.addEventListener("DOMContentLoaded", function() {
    const mainFooter = document.getElementById("mainFooter");
    const logoutBtn = document.getElementById("logoutBtn");

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙˆØªØ±)
    const isLoggedIn = localStorage.getItem(MARKETER_SESSION_KEY);
    if (isLoggedIn) {
      mainFooter.style.display = "block";
    }

    function logoutUser() {
      const confirmLogout = confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ");
      if (!confirmLogout) return;

      localStorage.removeItem(DEVICE_SERIAL_KEY);
      localStorage.removeItem(MARKETER_SESSION_KEY);
      localStorage.removeItem(OTP_PENDING_KEY);
      localStorage.removeItem(LOCAL_MARKETER_KEY); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø®Ø²Ù†
      localStorage.removeItem('dashboardStats');

      mainFooter.style.display = "none";
      window.location.href = "login.html";
    }

    if (logoutBtn) {
      logoutBtn.addEventListener("click", logoutUser);
    }
    
    // ğŸš¨ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    initDashboard();
  });

// ===============================================
// --- Ù…Ù†Ø·Ù‚ Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„ØªØ®ÙÙŠØ¶ (Ù…Ù† dashboard-unified.js) ---
// ===============================================

  const PASSWORD_CHECK_URL = 'https://script.google.com/macros/s/AKfycbw8WP1PDLGh45pD-50As-LmwGPqKdpSIOxxvlDHQk66DlJ5NyamHrSUFFTlZs5yCAmppw/exec';
  const ADMIN_MARKETER_ID = 'TTTTTT11';
  const ADMIN_AUTH_KEY = 'admin_verified_' + ADMIN_MARKETER_ID;

  async function verifyPasswordPOST(marketerId, password) {
    // ... (Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ù†ÙØ³Ù‡) ...
    try {
      const res = await fetch(PASSWORD_CHECK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ marketerId: marketerId, password: password })
      });

      if (!res.ok) {
        console.error('HTTP error', res.status);
        return false;
      }

      const data = await res.json();
      return Boolean(data.success);
    } catch (err) {
      console.error('Network error', err);
      return false;
    }
  }

  function renderDiscountSection() {
    const container = document.getElementById('discount-container');
    if (!container) return;

    // ğŸ’¡ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ù…Ù† getMarketerId
    const marketerId = getMarketerId();
    const verified = sessionStorage.getItem(ADMIN_AUTH_KEY) === '1';

    if (marketerId === ADMIN_MARKETER_ID && verified) {
      container.style.display = 'block';
    } else {
      container.style.display = 'none';
    }
  }

    
  async function onDiscountSearchClickSecure() {
    // ğŸ’¡ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ù…Ù† getMarketerId
    const marketerId = getMarketerId();
    if (!marketerId) {
      alert('Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©.');
      return;
    }

    if (sessionStorage.getItem(ADMIN_AUTH_KEY) !== '1') {
      const pwd = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ØªØ­Ù‚Ù‚:');
      if (!pwd) return;

      const ok = await verifyPasswordPOST(marketerId, pwd);
      if (!ok) {
        alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©.');
        return;
      }

      sessionStorage.setItem(ADMIN_AUTH_KEY, '1');
      renderDiscountSection();
      alert('ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ®ÙÙŠØ¶.');
      return;
    }

    const code = document.getElementById('discount-input').value.trim();
    if (!code) {
      alert('Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ®ÙÙŠØ¶ Ø£ÙˆÙ„Ø§Ù‹.');
      return;
    }

    alert('ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯: ' + code);
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Ø±Ø¨Ø· Ø­Ø¯Ø« Ø²Ø± Ø§Ù„ØªØ®ÙÙŠØ¶
    const btn = document.getElementById('discount-search-btn');
    if (btn) btn.addEventListener('click', onDiscountSearchClickSecure);
    
    // ØªØ´ØºÙŠÙ„ Ø±Ù†Ø¯Ø± Ø§Ù„ØªØ®ÙÙŠØ¶ (Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡ Ø£ÙŠØ¶Ø§Ù‹ Ø¹Ø¨Ø± initDashboard)
    renderDiscountSection();
  });
</script>


<script>

// ===============================================
// --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù…Ù† home-logic.js Ùˆ unified-stats.js) ---
// ===============================================

// ğŸ›‘ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxbYeuziWHe6ODINemry6n3XNfXTpDrZ2jxo1GXG9bAjm6AAhiCyogt3p1Y48qvJ1kppQ/exec';
const BASE_REGISTRATION_URL = 'https://skillia.netlify.app/courses.html';
const STATS_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzWWwBEaENCjKz9wHskpdiZtCu6m__zdMxTzww2bExowoAWdhFAhChEjM7Cb5IOBTFnjA/exec';

// Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù€ DOM
const statusMessage = document.getElementById('statusMessage');
const dashboardContent = document.getElementById('dashboardContent');
const marketerIdDisplay = document.getElementById('marketer-id-display');
const referralsCount = document.getElementById('referrals-count');
const activeReferralsCount = document.getElementById('active-referrals-count');
const referralLinkText = document.getElementById('referral-link-text');
const copyBtn = document.getElementById('copy-btn');
const downloadBtn = document.getElementById('download-btn');
const referralsTableContainer = document.getElementById('referrals-table-container');
const searchInput = document.getElementById('searchInput');
const toastNotification = document.getElementById('toastNotification');
const refreshBalanceBtn = document.getElementById('refresh-balance');
const balanceToast = document.getElementById('toast');


let currentReferralsList = [];
let toastTimeout;
// ğŸ’¡ ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± Ø¹Ø§Ù… Ù„Ù„Ø§Ø³Ù… Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙ†Ø²ÙŠÙ„
let marketerName = 'Marketer'; 


// Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙŠ Ù†Ø­ØªØ§Ø¬Ù‡Ø§ Ù„ØªÙ†Ø²ÙŠÙ„ CSV
const referralColumns = ['ØªØ§Ø±ÙŠØ®_Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 'fullname', 'phone', 'email', 'Ø§Ù„Ø­Ø§Ù„Ø©'];
const referralHeaders = ['Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„', 'Ø§Ù„Ù‡Ø§ØªÙ', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„'];

// ğŸš€ ØªØ¹Ø±ÙŠÙ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
const cardFields = [
    { key: 'ØªØ§Ø±ÙŠØ®_Ø§Ù„ØªØ³Ø¬ÙŠÙ„', label: 'Ø§Ù„ØªØ§Ø±ÙŠØ®', icon: 'fas fa-calendar-alt' },
    { key: 'phone', label: 'Ø§Ù„Ù‡Ø§ØªÙ', icon: 'fab fa-whatsapp' },
    { key: 'email', label: 'Ø§Ù„Ø¨Ø±ÙŠØ¯', icon: 'fas fa-envelope' },
];


// ----------------------------------------------------
// --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ---
// ----------------------------------------------------

function updateStatus(message, type = 'loading') {
    statusMessage.classList.remove('loading', 'success', 'error');
    statusMessage.classList.add(type);
    statusMessage.style.display = 'block';

    if (type === 'loading') {
        statusMessage.innerHTML = `<span class="spinner"></span> ${message}`;
        dashboardContent.style.display = 'none';
    } else {
        statusMessage.innerHTML = message;
    }
}

function showToast(message) {
    toastNotification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    toastNotification.classList.add('show');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => {
        toastNotification.classList.remove('show');
    }, 2000);
}

function showBalanceToast(msg, isError=false) {
  balanceToast.textContent = msg;
  balanceToast.style.background = isError ? '#d9534f' : '#007b83';
  balanceToast.classList.add('show');
  setTimeout(() => balanceToast.classList.remove('show'), 2500);
}


function getStatusHtml(statusValue) {
    const normalizedValue = String(statusValue).trim().toUpperCase();

    if (normalizedValue === 'Y') {
        return { name: 'ØªÙ… Ø§Ù„Ø¯ÙØ¹', value: '<span class="card-status status-active">ğŸŸ¢ ØªÙ… Ø§Ù„Ø¯ÙØ¹ </span>', class: 'status-Y' };
    } else if (normalizedValue === 'N') {
        return { name: 'Ù„Ù… ÙŠØ¯ÙØ¹', value: '<span class="card-status status-inactive">ğŸ”´ Ù„Ù… ÙŠØ¯ÙØ¹ </span>', class: 'status-N' };
    }
    return { name: 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', value: '<span class="card-status" style="color: #ffc107;">â›” Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± </span>', class: 'status-pending' };
}

function updateMetaTags(data) {
    if (data.personal_data && data.personal_data.length > 0) {
        const marketerNameLocal = data.personal_data[0].fullname || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        const descriptionTag = document.querySelector('meta[property="og:description"]');
        const titleTag = document.querySelector('meta[property="og:title"]');

        if (titleTag) {
            titleTag.setAttribute('content', `Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ÙˆÙ‘ÙÙ‚ - ${marketerNameLocal}`);
        }
        if (descriptionTag) {
            descriptionTag.setAttribute('content', `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø§Ù„Ù…Ø³ÙˆÙ‘ÙÙ‚ ${marketerNameLocal}. Ø±Ø§Ø¬Ø¹ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø­Ø§Ù„ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.`);
        }
        document.title = `Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ…: ${marketerNameLocal}`;
    }
}


// ----------------------------------------------------
// --- Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (referrals) ---
// ----------------------------------------------------

function buildReferralsCards(referrals) {

    if (!referrals || referrals.length === 0) {
        const isFiltering = searchInput.value.length > 0;
        referralsTableContainer.innerHTML = isFiltering
            ? '<p class="no-data">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù†ØªØ§Ø¦Ø¬ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«.</p>'
            : '<p class="no-data">Ù„Ù… ÙŠØ³Ø¬Ù„ Ø£ÙŠ Ø´Ø®Øµ Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø·Ùƒ Ø¨Ø¹Ø¯.</p>';

        downloadBtn.style.display = 'none';
        searchInput.disabled = true;
        return;
    }

    searchInput.disabled = false;
    downloadBtn.style.display = 'flex';

    let htmlContent = '';

    referrals.forEach(referral => {
        const status = getStatusHtml(referral['Ø§Ù„Ø­Ø§Ù„Ø©']);

        let detailsHtml = cardFields.map(field => {
            const value = referral[field.key] || '---';
            const direction = field.key === 'phone' || field.key === 'email' ? 'ltr' : 'rtl';

            return `
                <p>
                    <i class="${field.icon}"></i>
                    <span class="label">${field.label}:</span>
                    <span class="value" style="direction:${direction};">${value}</span>
                </p>`;
        }).join('');

        htmlContent += `
            <div class="referral-card ${status.class}">
                <div class="card-header">
                    <h3 class="card-name">${referral.fullname || 'Ø§Ø³Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±'}</h3>
                    ${status.value}
                </div>
                <div class="card-details">
                    ${detailsHtml}
                </div>
            </div>
        `;
    });

    referralsTableContainer.innerHTML = htmlContent;
}


function filterReferrals() {
    const q = searchInput.value.toLowerCase();

    const filteredList = currentReferralsList.filter(referral => {
        const fullName = String(referral.fullname || '').toLowerCase();
        const phone = String(referral.phone || '').toLowerCase();
        const email = String(referral.email || '').toLowerCase();

        return fullName.includes(q) || phone.includes(q) || email.includes(q);
    });

    buildReferralsCards(filteredList);
}

function downloadCSV(data, marketerId) {
    if (!data || data.length === 0) return;
    let csv = referralHeaders.join(',') + '\n';
    data.forEach(row => {
        let rowData = referralColumns.map(key => {
            let value = row[key] || '';
            value = String(value).replace(/"/g, '""');
            if (value.includes(',')) {
                value = `"${value}"`;
            }
            return value;
        });
        csv += rowData.join(',') + '\n';
    });

    const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    // ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… marketerName
    link.setAttribute('download', `${marketerName}_${marketerId}.csv`); 
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}



function displayData(data) {
    dashboardContent.style.display = 'block';
    
    // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¹Ø±Ù Ù…ÙˆØ¬ÙˆØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
    const marketerId = getMarketerId();
    if (!marketerId) return; // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¯ ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡ ÙÙŠ initDashboard

    const updateTime = new Date().toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' });
    updateStatus(`<i class="fas fa-check-circle"></i> ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­ âœ… <span style="font-size:14px; margin-right: 15px;">| ğŸ“… Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${updateTime}</span>`, 'success');
    setTimeout(() => { statusMessage.style.display = 'none'; dashboardContent.style.display = 'block'; }, 2000);

    currentReferralsList = data.referrals_list || [];

    const activeCount = currentReferralsList.filter(r => String(r['Ø§Ù„Ø­Ø§Ù„Ø©']).trim().toUpperCase() === 'Y').length;
    activeReferralsCount.textContent = activeCount;

    updateMetaTags(data);

    // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø¹Ø±Ù
    if (data.personal_data && data.personal_data.length > 0) {
        // ğŸ’¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… marketerName
        marketerName = data.personal_data[0].fullname || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'; 
        document.querySelector('header h1').innerHTML = `Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ÙˆÙ‘ÙÙ‚ â€“ ${marketerName}`;
        marketerIdDisplay.innerHTML = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ${marketerName} ğŸ‘‹<br>Ù…Ø¹Ø±Ù‘ÙÙƒ: <span class="id-highlight">${marketerId}</span>`;
    } else {
         marketerIdDisplay.innerHTML = `Ù…Ø¹Ø±Ù‘ÙÙƒ: <span class="id-highlight">${marketerId}</span>`;
         marketerName = 'Marketer'; // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø®ØµÙŠØ©
    }

    referralsCount.textContent = data.referrals_count || 0;
    const fullReferralLink = `${BASE_REGISTRATION_URL}?marketer_id=${marketerId}`;
    referralLinkText.textContent = fullReferralLink;

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    buildReferralsCards(currentReferralsList);

    downloadBtn.onclick = () => downloadCSV(currentReferralsList, marketerId);
}


async function fetchData(marketerId) {
    updateStatus('Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª...');

    if (!marketerId || marketerId.length < 3) {
        updateStatus('âš ï¸ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø®Ø²Ù†.', 'error');
        return;
    }

    const fetchUrl = `${APPS_SCRIPT_URL}?marketerId=${marketerId.toUpperCase()}`;

    try {
        const response = await fetch(fetchUrl);
        const data = await response.json();

        if (data.status === 'success') {
            displayData(data);
        } else {
            const errorMsg = data.message || 'Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¹Ø±Ù ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø±.';
            updateStatus(`âŒ ${errorMsg}`, 'error');
        }
    } catch (error) {
        console.error('Fetch Error:', error);
        updateStatus('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ Ø§Ù„Ø®Ø§Ø¯Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.', 'error');
    }
}


// ----------------------------------------------------
// --- Ù…Ù†Ø·Ù‚ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ù…Ù†Ø§ÙØ³Ø© (Ù…Ù† Balance.html Ùˆ unified-stats.js) ---
// ----------------------------------------------------

async function fetchStats(id) {
  try {
    const res = await fetch(`${STATS_APP_SCRIPT_URL}?marketer_id=${encodeURIComponent(id)}`);
    const data = await res.json();

    if (data.success === false || data.error) {
      const errorMsg = data.message || data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù….';
      showBalanceToast('Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…: ' + errorMsg + ' âŒ', true);
      return null;
    }

    return data;

  } catch(err) {
    showBalanceToast('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø£Ùˆ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ âŒ', true);
    console.error('Fetch error:', err);
    return null;
  }
}


function updateBalanceUI(stats) {
  if (!stats) return;

  const commission = Number(stats.total_commission) || 0;

  document.getElementById('current-balance').textContent = commission.toLocaleString('en-US', {minimumFractionDigits:2}) + ' $';

  const totalRegistered = Number(stats.total_registered) || 0;
  const activeMembers = Number(stats.active) || 0;
  const inactiveMembers = Number(stats.inactive) || 0;

  document.getElementById('total-members').textContent = totalRegistered;
  document.getElementById('active-members').textContent = activeMembers;
  document.getElementById('inactive-members').textContent = inactiveMembers;

  const total = activeMembers + inactiveMembers;
  const activePercent = total ? (activeMembers/total)*100 : 0;
  const donut = document.getElementById('statusDonut');
  donut.style.background = `conic-gradient(#28a745 0% ${activePercent}%, #dc3545 ${activePercent}% 100%)`;

  document.getElementById('current-rank').textContent = stats.rank || 'N/A';

  const top3List = document.getElementById('top3-list');
  top3List.innerHTML = '';
  stats.top3.forEach((m) => {
    const topCommission = Number(m.total) || 0;
    if (m.name && topCommission > 0) {
      const li = document.createElement('li');
      const topCommissionText = topCommission.toLocaleString('en-US', {minimumFractionDigits:0});
      li.textContent = `${m.name} â€“ ${topCommissionText}$`;
      top3List.appendChild(li);
    }
  });

  // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙÙ‚Ø· (Ù…Ù†Ø·Ù‚ unified-stats.js)
  const fixedStats = {
    total_registered: totalRegistered,
    active: activeMembers,
    inactive: inactiveMembers,
    top3: stats.top3
  };
  localStorage.setItem('dashboardStats', JSON.stringify(fixedStats));
}

function loadDashboardFromStorage() {
  const fixedStats = JSON.parse(localStorage.getItem('dashboardStats'));
  if(fixedStats) {
    document.getElementById('total-members').textContent = fixedStats.total_registered;
    document.getElementById('active-members').textContent = fixedStats.active;
    document.getElementById('inactive-members').textContent = fixedStats.inactive;

    const total = fixedStats.total_registered;
    const activeMembers = fixedStats.active;
    const activePercent = total ? (activeMembers/total)*100 : 0;
    const donut = document.getElementById('statusDonut');
    donut.style.background = `conic-gradient(#28a745 0% ${activePercent}%, #dc3545 ${activePercent}% 100%)`;


    const top3List = document.getElementById('top3-list');
    top3List.innerHTML = '';
    fixedStats.top3.forEach((m) => {
      const li = document.createElement('li');
      const topCommission = Number(m.total) || 0;
      li.textContent = `${m.name} â€“ ${topCommission.toLocaleString('en-US', {minimumFractionDigits:0})}$`;
      top3List.appendChild(li);
    });
  }
}

async function initBalanceDisplay() {
    
  const marketerId = getMarketerId();
    
  if (!marketerId) {
    const balanceElement = document.getElementById('current-balance');
    balanceElement.textContent = 'âš ï¸ Ø§Ù„Ù…Ø¹Ø±Ù Ù…ÙÙ‚ÙˆØ¯';
    balanceElement.style.fontSize = '1.8rem';

    document.getElementById('total-members').textContent = '0';
    document.getElementById('active-members').textContent = '0';
    document.getElementById('inactive-members').textContent = '0';
    document.getElementById('current-rank').textContent = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    document.getElementById('top3-list').innerHTML = '<li>--</li><li>--</li><li>--</li>';
    showBalanceToast('Ø®Ø·Ø£: Ø§Ù„Ù…Ø¹Ø±Ù ØºÙŠØ± Ù…ØªÙˆÙØ± ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© âŒ', true);
    return;
  }

  loadDashboardFromStorage();


  document.getElementById('current-balance').innerHTML = '<div class="loader"></div>';
  document.getElementById('current-balance').style.fontSize = '2.8rem';

  const stats = await fetchStats(marketerId);
  updateBalanceUI(stats);
  if (stats) showBalanceToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
}


// ===============================================
// --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯ÙˆØ±Ø§Øª (Ù…Ù† dialog.html Ø§Ù„Ù…Ø¯Ù…Ø¬) ---
// ===============================================

// â›”â›”â›” Ù‡Ø§Ù…: ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù…Ù„Ù dialog.html â›”â›”â›”
const COURSE_APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvaDty4OhXdnR3poYEuwj9W53esn2923XYpKZc7LTKf_M17Z576YGP_EkjB9bt-hN8pA/exec";

let COURSES = []; 
let dialogMarketerId = ''; // Ø³ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø¯Ø§ÙŠÙ„ÙˆØ¬

/**
 * Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ù…Ù† Google Sheets API
 */
async function fetchCourses() {
    const listContainer = document.getElementById('courseList');
    listContainer.innerHTML = '<div style="text-align:center; padding: 20px; color:#555;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª...</div>';
    
    try {
        const response = await fetch(COURSE_APP_SCRIPT_URL);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        if (data && data.courses && Array.isArray(data.courses)) {
            COURSES = data.courses; 
            renderCourseList(); 
        } else {
            throw new Error("ØªÙ†Ø³ÙŠÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….");
        }
    } catch (error) {
        console.error("Error fetching courses:", error);
        listContainer.innerHTML = '<div style="text-align:center; padding: 20px; color:#ef4444;">âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø§Ø¨Ø· Apps Script.</div>';
    }
}


/**
 * Ø¨Ù†Ø§Ø¡ ÙˆØ¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
 */
function renderCourseList() {
    const listContainer = document.getElementById('courseList');
    listContainer.innerHTML = ''; 

    if (COURSES.length === 0) {
         listContainer.innerHTML = '<div style="text-align:center; padding: 20px; color:#555;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
         return;
    }

    COURSES.forEach(course => {
        const item = document.createElement('div');
        item.className = 'course-item';
        
        item.innerHTML = `
          <span>${course.name}</span>
          <span class="levies-text-red">Ø§Ù„Ø±Ø³ÙˆÙ…: ${course.levies} $</span>
        `;
        
        // Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ø¶ØºØ· Ø¨Ø§Ù„Ø¯Ø§Ù„Ø© copyLink
        item.addEventListener('click', () => copyLink(course.slug));
        listContainer.appendChild(item);
    });
}

/**
 * ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø¹Ø±Ø¶ ÙˆØ¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª
 */
function toggleList() {
    const list = document.getElementById('courseList');
    const arrow = document.getElementById('arrowCourses');
    const isVisible = list.style.display === 'block';
    
    list.style.display = isVisible ? 'none' : 'block';
    arrow.classList.toggle('rotate');

    if (!isVisible && COURSES.length === 0) {
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±Ø¦ÙŠØ© ÙˆØ§Ù„Ø¯ÙˆØ±Ø§Øª Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ø¨Ø¹Ø¯ØŒ ÙÙ‚Ù… Ø¨Ø¬Ù„Ø¨Ù‡Ø§
        fetchCourses();
    }
}


/**
 * Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ÙˆÙ‘ÙÙ‚
 */
function copyLink(courseSlug) {
    const baseUrl = "https://skillia.netlify.app/course.html"; 
    // ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… dialogMarketerId Ø§Ù„Ù…ÙØ®Ø²Ù‘Ù† Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø¯Ø§ÙŠÙ„ÙˆØ¬
    let fullLink = baseUrl + "?id=" + courseSlug;
    fullLink += "&marketer_id=" + dialogMarketerId;
    
    navigator.clipboard.writeText(fullLink).then(() => {
        const msg = document.getElementById('messageCourses');
        msg.style.display = 'block';
        msg.innerHTML = `ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙˆØ±Ø© <span style="font-weight: bold; color: #1d4ed8;">${courseSlug.toUpperCase()}</span> Ø¨Ù†Ø¬Ø§Ø­!<br> ØªÙ… Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯Ùƒ: <span style="font-weight: bold;">${dialogMarketerId}</span> âœ…`;
        setTimeout(() => msg.style.display = 'none', 3000);
    });
}


/**
 * Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø¯Ø§ÙŠÙ„ÙˆØ¬
 */
function initializeDialog() {
    // 1. Ø§Ø³ØªØ®Ù„Ø§Øµ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ÙˆÙ‘ÙÙ‚ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø¯Ø§ÙŠÙ„ÙˆØ¬
    dialogMarketerId = getMarketerIdForDialog();
    
    // 2. ØªØ­Ø¯ÙŠØ« Ø±Ø£Ø³ Ø§Ù„Ø¯Ø§ÙŠÙ„ÙˆØ¬ Ù„Ø¹Ø±Ø¶ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ÙˆÙ‘ÙÙ‚
    const header = document.getElementById('dialogHeaderCourses');
    header.innerHTML = `ğŸ“Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ù„ØªØ³ÙˆÙ‚ Ù„Ù‡Ø§ (ÙƒÙˆØ¯Ùƒ: <span style="color:#2563eb;">${dialogMarketerId}</span>)`;
    
    // 3. Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ (ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù€ ID Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ø¯Ù…Ø¬)
    const toggleBtn = document.getElementById('toggleButtonCourses');
    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø­Ø¯Ø« Ø³Ø§Ø¨Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø¨Ø· Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
    toggleBtn.removeEventListener('click', toggleList);
    toggleBtn.addEventListener('click', toggleList);
    
    // 4. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙƒÙ„ ÙØªØ­ Ø¬Ø¯ÙŠØ¯
    const list = document.getElementById('courseList');
    const arrow = document.getElementById('arrowCourses');
    list.style.display = 'none';
    arrow.classList.remove('rotate');
}

// ----------------------------------------------------
// --- ØªÙ†ÙÙŠØ° Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ù€ Event Listeners (ØªØ­Ø¯ÙŠØ«) ---
// ----------------------------------------------------

document.addEventListener('DOMContentLoaded', () => {

    window.filterReferrals = filterReferrals;
    window.downloadCSV = downloadCSV;

    copyBtn.addEventListener('click', async () => {
        const link = referralLinkText.textContent;
        try {
            await navigator.clipboard.writeText(link);
            showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©!');
        } catch (err) {
            console.error('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®:', err);
            showToast('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.');
        }
    });

    if (refreshBalanceBtn) {
        refreshBalanceBtn.addEventListener('click', initBalanceDisplay);
    }
});


</script>
</body>
</html>
